name: CI Pipeline with TestContainers

on:
  push:
    branches: [ main, feature/*, master]
  pull_request:
    branches: [ main ]

jobs:
  test-with-testcontainers:
    runs-on: ubuntu-latest

    # üîë –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è GITHUB_TOKEN
    permissions:
      contents: read
      checks: write
      pull-requests: write

    # ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –í–∫–ª—é—á–µ–Ω–∏–µ Docker-in-Docker
    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Docker –¥–ª—è TestContainers
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'

    # üî• –í–ê–ñ–ù–û: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gradle –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Prepare
      run: chmod +x gradlew

    # üê≥ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è TestContainers
    - name: Pull TestContainers images
      run: |
        docker pull postgres:15-alpine
        docker pull testcontainers/ryuk:0.5.1

    # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Liquibase —á–µ—Ä–µ–∑ Testcontainers
    - name: Validate Liquibase migrations
      run: ./gradlew liquibaseValidateCi
      env:
        TESTCONTAINERS_REUSE_ENABLE: true
        TESTCONTAINERS_CHECKS_DISABLE: true
        GRADLE_OPTS: -Xmx2g -XX:MaxMetaspaceSize=512m

    # üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å TestContainers
    - name: Run integration tests
      run: ./gradlew test --info
      env:
        # ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è CI —Å—Ä–µ–¥—ã
        TESTCONTAINERS_REUSE_ENABLE: true
        TESTCONTAINERS_CHECKS_DISABLE: true
        # üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        GRADLE_OPTS: -Xmx2g -XX:MaxMetaspaceSize=512m

    # üìä –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è pull requests –∏–∑ —Ñ–æ—Ä–∫–æ–≤ (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ check runs)
    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: (success() || failure()) && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
      with:
        name: TestContainers Integration Tests
        path: 'build/test-results/test/*.xml'
        reporter: java-junit

    # üìà –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
    - name: Generate JaCoCo coverage report
      run: ./gradlew jacocoTestReport
      if: always()

    - name: Upload JaCoCo coverage report
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      with:
        name: jacoco-report-${{ github.run_id }}
        path: build/reports/jacoco/test/html
        retention-days: 7

  # üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  # –û—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –≤–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  performance-tests:
    runs-on: ubuntu-latest
    needs: test-with-testcontainers
    if: false  # –û—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å: –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ 'true' –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ matrix

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'

    - name: Prepare
      run: chmod +x gradlew

    # üî• –ó–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞–º—è—Ç–∏
    - name: Run performance tests
      run: ./gradlew test -PmaxHeapSize=4g
      env:
        # üê≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –ë–î
        TESTCONTAINERS_REUSE_ENABLE: true
        POSTGRES_MAX_CONNECTIONS: 200
        HIKARI_MAXIMUM_POOL_SIZE: 50
        GRADLE_OPTS: -Xmx4g -XX:MaxMetaspaceSize=1g
